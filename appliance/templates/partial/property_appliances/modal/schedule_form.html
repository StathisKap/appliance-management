{% load appliance_filters %}

<form hx-post="{% url 'appliance_replacement_modal_submit' %}">
  <input type="hidden" name="property_appliance_id" value="{{ property_appliance_id }}">
  <input type="hidden" name="replacement_appliance_id" value="{{ appliance.id }}">
  <h2 class="fs-3 mb-3">Please select data and time</h2>
  <div class="mb-4">
    <label class="text-muted mb-2">Select a date</label>
    <div class="d-flex gap-2 flex-wrap mb-3">
      {% for date in dates|next_available_dates %}
        <div class="date-option border rounded p-3 text-center position-relative flex-grow-1 {% if forloop.last %}bg-light{% endif %}">
          <span class="fs-4">{{ date.date|parse_date|date:"jS M" }}</span>
          <input type="radio"
                 name="date"
                 value="{{ date.date }}"
                 class="position-absolute opacity-0"
                 {% if forloop.last %}checked{% endif %}>
          {% if forloop.last %}
            <div class="position-absolute top-0 end-0 translate-middle-y checkmark-container">
              <i class="bi bi-check-lg bg-dark rounded-circle text-white p-1 d-flex align-items-center justify-content-center fs-6"></i>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="mb-4">
      <div class="border rounded p-3">
        <div class="text-center calendar-trigger">
          <span class="fs-5">Select Other Date</span>
        </div>
        <div id="calendar-container">
          {% include "partial/property_appliances/modal/calendar.html" %}
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-6 mb-3 mb-md-0">
        <label class="text-muted mb-2">Select time (hour)</label>
        <select class="form-select form-control-lg py-3" name="hour">
          {% with first_available=dates|next_available_dates:1|first %}
            {% for hour in first_available.available_hours %}
              <option value="{{ hour }}">{{ hour }}</option>
            {% endfor %}
          {% endwith %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="text-muted mb-2">Select time (Minutes)</label>
        <select class="form-select form-control-lg py-3" name="minute">
          {% with first_available=dates|next_available_dates:1|first %}
            {% for minute in first_available.available_minutes %}
              <option value="{{ minute }}">{{ minute }}</option>
            {% endfor %}
          {% endwith %}
        </select>
      </div>
    </div>

    <div class="mb-4">
      <div class="form-check form-switch custom-switch">
        <input class="form-check-input"
               type="checkbox"
               id="notificationToggle"
               name="notifications_enabled">
        <label class="form-check-label ms-2 text-muted" for="notificationToggle">
          Want to enter tenat email and number to send notification of delivery and reminders? (Optional)
        </label>
      </div>
    </div>

    <div id="notification-fields" class="d-none mb-4">
      <div class="row">
        <div class="col-md-6 mb-3 mb-md-0">
          <label class="form-label">Tenant Email</label>
          <input type="email"
                 class="form-control"
                 name="tenant_email"
                 placeholder="Email address">
        </div>
        <div class="col-md-6">
          <label class="form-label">Tenant Phone</label>
          <input type="tel"
                 class="form-control"
                 name="tenant_phone"
                 placeholder="Phone number">
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between mt-3">
    <button type="submit" class="btn btn-primary flex-grow-1 me-2">Confirm</button>
    <button type="button" class="btn btn-secondary flex-grow-1" data-bs-dismiss="modal">Cancel</button>
  </div>
</form>

<style>
  .date-option input {
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    cursor: pointer;
  }
  .checkmark-container i {
    margin-right: -11px;
    width: 22px;
    height: 22px;
  }
  .custom-switch .form-check-input {
    width: 3em;
    height: 1.5em;
  }
  .calendar-trigger {
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0.5rem;
  }
  .calendar-trigger:hover {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
  }
  #calendar-container {
    transition: all 0.3s ease;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transform: translateY(-10px);
    margin: 0;
    padding: 0;
  }
  #calendar-container.show {
    max-height: 500px;
    opacity: 1;
    transform: translateY(0);
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
  }
</style>

<script>
  // Toggle notification fields visibility
  document.getElementById('notificationToggle').addEventListener('change', function() {
    document.getElementById('notification-fields').classList.toggle('d-none');
  });

  // Handle date option selection
  document.querySelectorAll('.date-option').forEach(option => {
    option.addEventListener('click', function() {
      // Remove selected class and checkmark from all options
      document.querySelectorAll('.date-option').forEach(opt => {
        opt.classList.remove('bg-light');
        const checkmark = opt.querySelector('.checkmark-container');
        if (checkmark) checkmark.remove();
      });

      // Add selected class and checkmark to clicked option
      this.classList.add('bg-light');
      if (!this.querySelector('.checkmark-container')) {
        const checkmark = document.createElement('div');
        checkmark.className = 'position-absolute top-0 end-0 translate-middle-y checkmark-container';
        checkmark.innerHTML = '<i class="bi bi-check-lg bg-dark rounded-circle text-white p-1 d-flex align-items-center justify-content-center fs-6"></i>';
        this.appendChild(checkmark);
      }

      // Update time selects with available hours and minutes for selected date
      const date = this.querySelector('input').value;
      const selectedDate = {{ dates|safe }}.find(d => d.date === date);
      if (selectedDate) {
        updateTimeSelect('hour', selectedDate.available_hours);
        updateTimeSelect('minute', selectedDate.available_minutes);
      }
    });
  });

  function updateTimeSelect(name, values) {
    const select = document.querySelector(`select[name="${name}"]`);
    select.innerHTML = '';
    values.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
  }

  // Handle calendar toggle
  document.querySelector('.calendar-trigger').addEventListener('click', function() {
    const calendarContainer = document.getElementById('calendar-container');
    calendarContainer.classList.toggle('show');
  });

  document.addEventListener('DOMContentLoaded', function() {
    setupCalendarRadioListeners();

    // Make sure calendar toggle works
    const calendarTrigger = document.querySelector('.calendar-trigger');
    if (calendarTrigger) {
      calendarTrigger.addEventListener('click', function() {
        const calendarContainer = document.getElementById('calendar-container');
        if (calendarContainer) {
          calendarContainer.classList.toggle('show');
        }
      });
    }

    // Handle the notification toggle
    const notificationToggle = document.getElementById('notificationToggle');
    if (notificationToggle) {
      // Ensure notifications_enabled is properly set on initial load
      const hiddenInput = document.querySelector('input[name="notifications_enabled"]');
      if (!hiddenInput) {
        // If there's no hidden input for notifications_enabled, create one
        const form = notificationToggle.closest('form');
        if (form) {
          const newHiddenInput = document.createElement('input');
          newHiddenInput.type = 'hidden';
          newHiddenInput.name = 'notifications_enabled';
          newHiddenInput.value = notificationToggle.checked ? 'true' : 'false';
          form.appendChild(newHiddenInput);
        }
      }

      // Update the notifications_enabled value whenever the toggle changes
      notificationToggle.addEventListener('change', function() {
        // Toggle visibility of the notification fields
        const notificationFields = document.getElementById('notification-fields');
        if (notificationFields) {
          notificationFields.classList.toggle('d-none', !this.checked);
        }

        // Find or create the hidden input
        let hiddenInput = document.querySelector('input[type="hidden"][name="notifications_enabled"]');
        if (!hiddenInput) {
          hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'notifications_enabled';
          this.closest('form').appendChild(hiddenInput);
        }

        // Update the value
        hiddenInput.value = this.checked ? 'true' : 'false';
      });

      // Trigger the change event initially to set the correct value
      notificationToggle.dispatchEvent(new Event('change'));
    }
  });

  // Add this to ensure form submission includes the notifications_enabled value
  document.addEventListener('submit', function(e) {
    if (e.target.matches('form')) {
      const notificationToggle = document.getElementById('notificationToggle');
      if (notificationToggle) {
        // Make sure we have the notifications_enabled field with the correct value
        let hiddenInput = e.target.querySelector('input[type="hidden"][name="notifications_enabled"]');
        if (!hiddenInput) {
          hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = 'notifications_enabled';
          e.target.appendChild(hiddenInput);
        }

        hiddenInput.value = notificationToggle.checked ? 'true' : 'false';
      }
    }
  });
</script>
